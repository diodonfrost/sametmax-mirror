<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	xmlns:georss="http://www.georss.org/georss" xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#" >

<channel>
	<title>varnish &#8211; Sam &amp; Max</title>
	<atom:link href="http://sametmax.com/tag/varnish/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Thu, 05 Sep 2019 08:22:03 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.9.7</generator>
<site xmlns="com-wordpress:feed-additions:1">32490438</site>	<item>
		<title>C&#8217;est l&#8217;histoire d&#8217;un blog qui traverse la route et PAF le blog</title>
		<link>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/</link>
		<comments>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/#comments</comments>
		<pubDate>Tue, 01 Oct 2013 13:49:17 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Philo et culture]]></category>
		<category><![CDATA[hosting]]></category>
		<category><![CDATA[meta]]></category>
		<category><![CDATA[varnish]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7290</guid>
		<description><![CDATA[Retour à la normale, avec notre bon vieux WP pourri, un cache trop agressif devant, un design moche et des articles honteux.]]></description>
				<content:encoded><![CDATA[<p>Retour à la normale, avec notre bon vieux WP pourri, un cache trop agressif devant, un design moche et des articles honteux.</p>
<p>Bienvenue sur Sam et Max.</p>
<p>Donc après que Lease Web nous ait lâché plusieurs fois dans le mois, notre Varnish a décidé de ne pas fonctionner pour une raison qui restera mystérieuse. Du coup on a pris un autre hébergeur, et Max, dans une tentative désespérée avant la migration, a tenté une cure par imposition des mains.</p>
<p>Ça a marché, du coup j&#8217;ai pris un serveur pour rien ^^ On va rester sur ce serveur du fait de notre flemme légendaire et parce que, bah, on a aucun revenu attaché au blog donc si il est pas disponible ça nous coûte rien à part de répondre aux tweets attristés des fans.</p>
<p>Bref, je reviens avec plein d&#8217;idées d&#8217;articles, des concepts novateurs (qui ne verront jamais le jour par manque de temps, mais c&#8217;est l&#8217;intention qui fait le forgeron) et quelques millions d&#8217;entrées dans les mails, flux RSS et autres outils dit &#8220;d&#8217;information&#8221; qui ont pour mission de s&#8217;assurer que vous n&#8217;aurez jamais la bonne, noyée dans la masse.</p>
<p>Notre référencement s&#8217;est évidement fait plomber, car un bonheur n&#8217;arrive jamais seul. Mais on s&#8217;en fout parce qu&#8217;on a encore pu profiter de la plage et du soleil pendant que vous êtes tous sous la grisaille. Et savoir que la situation des autres est pire que la sienne, ça n&#8217;a pas de prix.</p>
<p>C&#8217;est reparti !</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/cest-dun-blog-qui-traverse-la-route-et-paf-le-blog/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">7290</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/10/32678906.jpg" length="129224" type="image/jpg" />	</item>
		<item>
		<title>Savoir si une page est en cache avec Varnish</title>
		<link>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/</link>
		<comments>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/#comments</comments>
		<pubDate>Wed, 01 May 2013 07:44:34 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[cache]]></category>
		<category><![CDATA[hit]]></category>
		<category><![CDATA[miss]]></category>
		<category><![CDATA[varnish]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=5945</guid>
		<description><![CDATA[Petite astuce pour savoir si Varnish fait bien son boulot. L'affichage dans les Headers d'un debug permettant de savoir si votre page a bien été servit depuis le cache plutôt que le backend.]]></description>
				<content:encoded><![CDATA[<p>Pour savoir si cette feignasse de Varnish a bien fait son boulot voici une petite astuce pour afficher dans les HEADERS de son navigateur la provenance de la page, le cache ou le backend.<br />
Varnish propose dans son <a href="https://www.varnish-cache.org/trac/wiki/VCLExampleHitMissHeader">wiki</a> cette méthode.</p>
<p><strong><br />
dans le fichier de conf de Varnish:</strong></p>
<pre lang="bash">
vi /etc/varnish/default.vcl 
</pre>
<p><b>et rajoutez ces quelques lignes:</b></p>
<pre lang="bash">
sub vcl_deliver {
        if (obj.hits > 0) {
                set resp.http.X-Cache = "HIT";
        } else {
                set resp.http.X-Cache = "MISS";
        }
}
</pre>
<p><b>On redemarre le service pour prendre en compte les changements:</b></p>
<pre lang="bash">
service varnishd restart
</pre>
<p><b>Dans le navigateur:</b></p>
<p><img src="http://sametmax.com/wp-content/uploads/2013/04/varnish.png" alt="" title="ça devrait cristalliser..." width="300" height="329" class="aligncenter size-full wp-image-5949" /></p>
<p>Comme on le voit ici, la page a été servie par le backend, si ce n&#8217;était pas prévu il va falloir revoir vos règles.</p>
<p>ATTENTION: Pensez à bien rafraichir votre navigateur pour être sur que ce ne soit pas la page mise en cache par ce dernier qui soit affichée, personnellement j&#8217;utilise la version navigation privé de chrome.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/savoir-si-une-page-est-en-cache-avec-varnish/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">5945</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/04/1221965226fv47Eh.jpg" length="24506" type="image/jpg" />	</item>
		<item>
		<title>Initiation à Varnish &#8211; Accélerer un blog WordPress</title>
		<link>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/</link>
		<comments>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/#comments</comments>
		<pubDate>Sun, 31 Mar 2013 08:54:54 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[varnish]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4416</guid>
		<description><![CDATA[Wordpress est devenu une usine à gaz avec le temps. Naviguer sur un blog sous Wordpress peut devenir pénible lorsque ce dernier a beaucoup de contenu ou de visiteurs. Des plugins censés mettre en cache les pages existent comme WP Cache, il y a aussi une façon d'attaquer le problème autrement avec Varnish.]]></description>
				<content:encoded><![CDATA[<p><a href="https://www.varnish-cache.org/">Varnish</a> est un service qui permet de mettre en cache (sur disque ou en mémoire) certains contenus de votre site. Beaucoup de gros sites l&#8217;utilisent pour sa puissance et ses options de configuration.<br />
Il est plutôt facile à installer mais ça se corse lorsqu&#8217;il faut le configurer car il peut ne rien cacher du tout, surtout avec la config par défaut.</p>
<p>Nous allons voir ici une configuration pour un site sous WordPress avec un serveur Nginx, Varnish étant placé en Front c&#8217;est à dire devant Nginx (il y a aussi le mode sandwich Nginx / Varnish / Backend).</p>
<p><img class="aligncenter size-full wp-image-4417" title="Varnish en Front" src="http://sametmax.com/wp-content/uploads/2013/02/varnish.png" alt="" width="580" height="272" /></p>
<p><strong>Installation de Varnish sous ubuntu:<br />
</strong></p>
<pre lang="bash">
sudo apt-get install varnish
</pre>
<p>Il y a 2 fichiers qu&#8217;il faut retenir pour Varnish, le fichier avec les règles et le fichier de config du service.<br />
<strong><br />
Configurer le service, On va faire en sorte que Varnish écoute sur le port 80:</strong></p>
<pre lang="bash">
vi /etc/default/varnish
</pre>
<pre lang="bash">
DAEMON_OPTS="-a :80 \
             -T localhost:6082 \
             -f /etc/varnish/default.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m"
</pre>
<p>Trouvez cette ligne dans le fichier de conf et mettez 80 pour l&#8217;option -a.<br />
<em>malloc</em> va sauver le cache en mémoire à hauteur de 256 MB, on peut sauvegarder sur disque si on a un SSD (ex: -s file,/var/lib/varnish/varnish_storage.bin,1G&#8221;).</p>
<p><strong>Configurer les règles de cache:</strong></p>
<pre lang="bash">
vi /etc/varnish/default.vcl
</pre>
<pre lang="bash">
#
# Varnish 3 configuration for WordPress
#
# On Debian OS:  /etc/varnish/default.vcl
#
# Nicolas Hennion (aka) Nicolargo
#

# Set the default backend (Nginx server for me)
backend default {
	# My Nginx server listen on IP address 127.0.0.1 and TCP port 8080
	.host = "127.0.0.1";
	.port = "8080";
	# Increase guru timeout
	# http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout
	.first_byte_timeout = 300s;
}

# This function is used when a request is send by a HTTP client (Browser) 
sub vcl_recv {
	# Block the forbidden IP addresse
	if (client.ip ~ forbidden) {
        	error 403 "Forbidden";
	}

	# Only cache the following sites
	if ((req.http.host ~ "(sametmax.com)")) { 
		set req.backend = default; 
	} else { 
		return (pass); 
	}

	# Normalize the header, remove the port (in case you're testing this on various TCP ports)
	set req.http.Host = regsub(req.http.Host, ":[0-9]+", "");

	# Post requests will not be cached
	if (req.http.Authorization || req.request == "POST") {
		return (pass);
	}

	# --- WordPress specific configuration
	
	# Did not cache the RSS feed
	if (req.url ~ "/feed") {
		return (pass);
	}

	# Blitz hack
        if (req.url ~ "/mu-.*") {
                return (pass);
        }

	
	# Did not cache the admin and login pages
	if (req.url ~ "/wp-(login|admin)") {
		return (pass);
	}

	# Remove the "has_js" cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "has_js=[^;]+(; )?", "");

	# Remove any Google Analytics based cookies
	set req.http.Cookie = regsuball(req.http.Cookie, "__utm.=[^;]+(; )?", "");

	# Remove the Quant Capital cookies (added by some plugin, all __qca)
	set req.http.Cookie = regsuball(req.http.Cookie, "__qc.=[^;]+(; )?", "");

	# Remove the wp-settings-1 cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wp-settings-1=[^;]+(; )?", "");

	# Remove the wp-settings-time-1 cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wp-settings-time-1=[^;]+(; )?", "");

	# Remove the wp test cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wordpress_test_cookie=[^;]+(; )?", "");

	# Are there cookies left with only spaces or that are empty?
	if (req.http.cookie ~ "^ *$") {
		    unset req.http.cookie;
	}
	
	# Cache the following files extensions 
	if (req.url ~ "\.(css|js|png|gif|jp(e)?g|swf|ico)") {
		unset req.http.cookie;
	}

	# Normalize Accept-Encoding header and compression
	# https://www.varnish-cache.org/docs/3.0/tutorial/vary.html
	if (req.http.Accept-Encoding) {
		# Do no compress compressed files...
		if (req.url ~ "\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$") {
			   	remove req.http.Accept-Encoding;
		} elsif (req.http.Accept-Encoding ~ "gzip") {
		    	set req.http.Accept-Encoding = "gzip";
		} elsif (req.http.Accept-Encoding ~ "deflate") {
		    	set req.http.Accept-Encoding = "deflate";
		} else {
			remove req.http.Accept-Encoding;
		}
	}

	# Check the cookies for wordpress-specific items
	if (req.http.Cookie ~ "wordpress_" || req.http.Cookie ~ "comment_") {
		return (pass);
	}
	if (!req.http.cookie) {
		unset req.http.cookie;
	}
	
	# --- End of WordPress specific configuration

	# Did not cache HTTP authentication and HTTP Cookie
	if (req.http.Authorization || req.http.Cookie) {
		# Not cacheable by default
		return (pass);
	}

	# Define the default grace period to serve cached content
	set req.grace = 30s;
	
	# Cache all others requests
	return (lookup);
}
 
sub vcl_pipe {
	return (pipe);
}
 
sub vcl_pass {
	return (pass);
}
 
# The data on which the hashing will take place
sub vcl_hash {
 	hash_data(req.url);
 	if (req.http.host) {
     	hash_data(req.http.host);
 	} else {
     	hash_data(server.ip);
 	}

	# If the client supports compression, keep that in a different cache
    	if (req.http.Accept-Encoding) {
        	hash_data(req.http.Accept-Encoding);
	}
     
	return (hash);
}
 
# This function is used when a request is sent by our backend (Nginx server)
sub vcl_fetch {
	# Remove some headers we never want to see
	unset beresp.http.Server;
	unset beresp.http.X-Powered-By;

	# For static content strip all backend cookies
	if (req.url ~ "\.(css|js|png|gif|jp(e?)g)|swf|ico") {
		unset beresp.http.cookie;
	}

	# Only allow cookies to be set if we're in admin area
	if (beresp.http.Set-Cookie && req.url !~ "^/wp-(login|admin)") {
        	unset beresp.http.Set-Cookie;
    	}

	# don't cache response to posted requests or those with basic auth
	if ( req.request == "POST" || req.http.Authorization ) {
        	return (hit_for_pass);
    	}
 
    	# don't cache search results
	if ( req.url ~ "\?s=" ){
		return (hit_for_pass);
	}
    
	# only cache status ok
	if ( beresp.status != 200 ) {
		return (hit_for_pass);
	}

	# A TTL of 24h
	set beresp.ttl = 24h;
	
	return (deliver);
}
 
# The routine when we deliver the HTTP request to the user
# Last chance to modify headers that are sent to the client
sub vcl_deliver {
	if (obj.hits > 0) { 
		set resp.http.X-Cache = "cached";
	} else {
		set resp.http.x-Cache = "uncached";
	}

	# Remove some headers: PHP version
	unset resp.http.X-Powered-By;

	# Remove some headers: Apache version & OS
	unset resp.http.Server;

	# Remove some heanders: Varnish
	unset resp.http.Via;
	unset resp.http.X-Varnish;

	return (deliver);
}
 
sub vcl_init {
 	return (ok);
}
 
sub vcl_fini {
 	return (ok);
}
</pre>
<p>Avant toute chose voici la doc :) : <a href="https://www.varnish-cache.org/docs/3.0/">https://www.varnish-cache.org/docs/3.0/</a><br />
Ce qu&#8217;il faut retenir de ce fichier de règles c&#8217;est les parties normalisation, enlever les cookies inutiles (car si cookie alors pas de cache) et ne pas mettre en cache l&#8217;admin. Cette config tourne actuellement sur S&#038;M.</p>
<p>Un point intéressant c&#8217;est le debug, vous pouvez mettre un <em>set resp.http.X-Cache = &#8220;cached&#8221;;</em> et vérifier les headers de votre serveur dans le debug de votre navigateur pour savoir si oui ou non la page servie est en cache.</p>
<p><strong>L&#8217;admin varnish en ligne de commande:</strong><br />
Varnish possède une admin en ligne de commande où l&#8217;on peut par exemple purger le cache d&#8217;une ou plusieurs pages.<br />
Tapez <em>varnishadm</em> dans le shell:</p>
<pre lang="bash">
varnishadm
200        
-----------------------------
Varnish Cache CLI 1.0
-----------------------------
Linux,3.2.0-25-virtual,x86_64,-smalloc,-smalloc,-hcritbit

Type 'help' for command list.
Type 'quit' to close CLI session.

varnish> ban.url /toto/ma-page.php
</pre>
<p>Pour purger une page on va utiliser la commande ban.url et y ajouter une partie de l&#8217;url à purger. On peut utiliser un ban en appelant également une url de purge avec Curl ou Wget pour les automations, il y a un excellent article <a href="http://binbash.fr/2011/11/15/purger-le-cache-de-varnish-3/">sur la purge ici.</a></p>
<p><strong>Configurer Nginx:</strong><br />
Une fois varnish installé, on va modifier un peu nginx pour que la liaison puisse se faire. Ci-dessous l&#8217;exemple de notre conf nginx.</p>
<pre lang="bash">

server {
    listen      8080;
    server_name  sametmax.com  ;
    root         /unrep/sametmax/;  # absolute path to your WordPress installation
    index index.php index.html;
    set_real_ip_from        127.0.0.1;
    real_ip_header          X-Forwarded-For;

    location ~ \.php$ {
        include        /etc/nginx/fastcgi_params;
        fastcgi_pass   127.0.0.1:53217;
        fastcgi_index index.php;
        fastcgi_buffers 8 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    }

</pre>
<p>Pour PHP on utilise spawn-fcgi que l&#8217;on gère avec <a href="http://supervisord.org/">supervisor</a> dont voici la conf dans /etc/supervisord.conf</p>
<pre lang="bash">
[program:php5-cgi]
command=/usr/local/bin/spawn-fcgi -u adolf -n -a 127.0.0.1 -p 53217 -P /tmp/fastcgi-php.pid -F 4 -- /usr/bin/php-cgi
redirect_stderr=true          ; redirect proc stderr to stdout (default false)
user=sametmax
autostart=true
autorestart=true
startsecs=10
startretries=9999999999999
stdout_logfile=/var/log/php5-cgi/php5-cgi.log
stdout_logfile_maxbytes=10MB   ; max # logfile bytes b4 rotation (default 50MB)
</pre>
<p><strong>Pour résumer:</strong></p>
<p>Dans cette configuration Varnish est en front end et va décider quand servir une page prise dans le cache (disque dur ou RAM) et quand interroger le backend pour servir une nouvelle page.<br />
Sur d&#8217;autres sites à fort trafic on a mis Nginx en front end car il encaisse beaucoup plus les hits et qu&#8217;il fait très bien le boulot pour servir des pages statiques.</p>
<p><strong>Attention!</strong><br />
Même si Varnish n&#8217;est pas compliqué à installer il peut être un vrai casse-tête quand il s&#8217;agit de cacher des pages. Pensez donc bien à normaliser vos headers (user-agent, gzip, etc), utilisez le debug.<br />
Bien configuré Varnish vous booste un serveur avec une réélle efficacité, il nous a sauvé 2 sites jusqu&#8217;à présent, ça sera d&#8217;ailleurs un standard sur nos prochains sites.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">4416</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/03/back_to_the_future.jpg" length="23411" type="image/jpg" />	</item>
	</channel>
</rss>
