<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	xmlns:georss="http://www.georss.org/georss" xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#" >

<channel>
	<title>nginx &#8211; Sam &amp; Max</title>
	<atom:link href="http://sametmax.com/tag/nginx/feed/" rel="self" type="application/rss+xml" />
	<link>http://sametmax.com</link>
	<description>Du code, du cul</description>
	<lastBuildDate>Thu, 05 Sep 2019 08:22:03 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.9.7</generator>
<site xmlns="com-wordpress:feed-additions:1">32490438</site>	<item>
		<title>Servir des fichiers statiques avec nginx</title>
		<link>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/</link>
		<comments>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/#comments</comments>
		<pubDate>Thu, 23 Oct 2014 06:20:02 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[css]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[static]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10490</guid>
		<description><![CDATA[C'est un truc donc j'ai tout le temps besoin, alors l'article servira de pense bête. ]]></description>
				<content:encoded><![CDATA[<p>C&#8217;est un truc dont j&#8217;ai tout le temps besoin, alors l&#8217;article servira de pense bête. Marre de chercher à chaque fois :</p>
<pre>
        # sur django, on met tout dans /static/, donc par habitude je le fais
        # pour tout
        location /static/ {

            # Le dossier doit contenir le dossier 'static'. Par exemple si votre
            # arbo est /home/sametmax/repo/static, le chemin sera
            # /home/sametmax/repo. Rassurez-vous, personne n'aura accès aux
            # autres sous dossiers de "repo".
            root  /chemin/absolu/vers/dossier/;

            # On active la compression
            gzip  on;
            gzip_http_version 1.0;
            gzip_vary on;
            gzip_comp_level 6;
            gzip_proxied any;
            gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
            gzip_buffers 16 8k;

            # Sauf pour les vieux nav
            gzip_disable ~@~\MSIE [1-6].(?!.*SV1)~@~];

            # On dit au navigateur de le mettre en cache pour 3 mois. Faites gaffe,
            # mettez un param dans les url de vos balises script/link qui change
            # à chaque version du fichier, sinon vous ne pourrez pas mettre à jour
            # vos fichiers.
            expires modified +90d;
        }
</pre>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/servir-des-fichiers-statiques-avec-nginx/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">10490</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2014/10/81RMYJLMA-L__AA1500_.jpg" length="204738" type="image/jpg" />	</item>
		<item>
		<title>Comment figer son app hors ligne pour plus d&#8217;un mois</title>
		<link>http://sametmax.com/comment-figer-son-app-hors-ligne-pour-plus-dun-mois/</link>
		<comments>http://sametmax.com/comment-figer-son-app-hors-ligne-pour-plus-dun-mois/#comments</comments>
		<pubDate>Fri, 25 Apr 2014 09:35:29 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[cache]]></category>
		<category><![CDATA[connerie]]></category>
		<category><![CDATA[html5]]></category>
		<category><![CDATA[manifest]]></category>
		<category><![CDATA[nginx]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=10076</guid>
		<description><![CDATA[Bravo Sam.]]></description>
				<content:encoded><![CDATA[<p>Je sers <a href="http://allthatcounts.net/">All That Counts</a> avec nginx, et le fichier de config est super simple :</p>
<pre>server {
        listen       80;
        server_name allthatcounts.net;

        error_log  /var/log/nginx/error_allthatcounts.log;
        access_log  /var/log/nginx/access_allthatcounts.log;

        location / {
            root /home/allthatcounts/www/;
            gzip  on;
            gzip_http_version 1.0;
            gzip_vary on;
            gzip_comp_level 6;
            gzip_proxied any;
            gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
            gzip_buffers 16 8k;
            gzip_disable ~@~\MSIE [1-6].(?!.*SV1)~@~];
            expires modified +90d;
        }
}</pre>
<p>En gros c&#8217;est juste du log et servir les fichiers statiques compressés avec gzip. Il n&#8217;y a rien de plus à faire parce qu&#8217;il n&#8217;y a pas de backend. Simple. Efficace.</p>
<p>La couille c&#8217;est que c&#8217;est un copier / coller d&#8217;un autre projet que j&#8217;ai fais sans trop réfléchir, et quand j&#8217;ai mis en prod de nouvelles modifications sur le serveurs, mon Firefox me les affichait pas. Pourtant j&#8217;avais bien modifié le manifeste, donc il aurait du tout recharcher&#8230;</p>
<p>Sauf que, con de ma race, j&#8217;ai copié la ligne :</p>
<pre>expires modified +90d;</pre>
<p>Qui dit techniquement, met en cache tous les fichiers statiques pour 90 jours. Donc aussi le manifeste. Du coup, toutes les personnes qui ont visité le site ne verront aucune mise à jour pour un bon mois et demi.</p>
<p>Bravo Sam.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/comment-figer-son-app-hors-ligne-pour-plus-dun-mois/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">10076</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2014/04/joker.gif" length="247256" type="image/jpg" />	</item>
		<item>
		<title>La stack techno qu&#8217;on utilise pour faire un site Web, et pourquoi</title>
		<link>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/</link>
		<comments>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/#comments</comments>
		<pubDate>Mon, 11 Nov 2013 06:40:38 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[celery]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[fabric]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[nosql]]></category>
		<category><![CDATA[postgres]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[redis]]></category>
		<category><![CDATA[vm]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7648</guid>
		<description><![CDATA[Une stack techno n'est pas une référence. Il n'y a pas de combo absolu qui rox absolument tout, c'est une question de contexte technique, financier, humain...

Mais c'est vrai que ça aide bien d'avoir sous les yeux les pratiques des autres.]]></description>
				<content:encoded><![CDATA[<p>Une stack techno n&#8217;est pas une référence. Il n&#8217;y a pas de combo absolu qui rox absolument tout, c&#8217;est une question de contexte technique, financier, humain&#8230;</p>
<p>Mais c&#8217;est vrai que ça aide bien d&#8217;avoir sous les yeux les pratiques des autres.</p>
<p>Je ne vais pas expliquer pourquoi Python, <a href="http://sametmax.com/10-raisons-pour-lesquelles-je-suis-toujours-marie-a-python/">je l&#8217;ai déjà fait</a>.</p>
<p>Commençons plutôt par la partie purement Web, pour laquelle on utilise Django, le framework Web Python.</p>
<p>Max et moi avons tout deux fait du PHP avant, j&#8217;ai tâté des frameworks internes, du Symfony et plus tard du Zope. J&#8217;ai regardé du côté de Pyramid et de ses prédécesseurs, et Django est celui qui me plaît le plus. J&#8217;ai juste un peu forcé la main à Max :-)</p>
<p>Car oui, le framework a été avant tout un choix de goût.</p>
<p>Ce n&#8217;est pas un choix de performances : le framework n&#8217;a aucun impact dessus. Aucun. Les architectures ont un impact. Le framework, non. Votre bottleneck sera sur les IO, pas sur le CPU. Le choix de technos asynchrones peut avoir un impact, mais ce n&#8217;est pas une question de framework. Tornado, Twisted ou NodeJS, on s&#8217;en fout. </p>
<p>Donc Django, essentiellement parce qu&#8217;il me plait. Et il me plaît pour ces raisons :</p>
<ul>
<li>Il y a un bon équilibre entre découplage et intégration. En général c&#8217;est soit très découplé et mal intégré, soit très bien intégré et très couplé.</li>
<li>C&#8217;est bien foutu et bien documenté. Et c&#8217;est stable. Vraiment très stable. Les core devs sont hyper sérieux.</li>
<li>C&#8217;est très versatile et ça peut faire plein de trucs out of the box, petits comme gros.</li>
<li>C&#8217;est assez facile à apprendre. Ça reste un framework, donc ce n&#8217;est pas la plus simple des démarches, mais dans le royaume des frameworks de cette taille, ça reste vraiment le plus simple.</li>
<li>La communauté est fantastique : il y a des centaines d&#8217;apps qui couvrent pratiquement tous les besoins.</li>
<li>Et bien entendu, c&#8217;est en Python.</li>
</ul>
<p>En terme de base de données, on a fait du MySQL pendant longtemps. Ça a plutôt bien marché. Maintenant je commence mes nouveaux projets avec PostGres, qui est plus solide. Parfois je fais juste du Sqlite, parce que ça suffit.</p>
<p>Pas de NoSQL. Après plusieurs expériences avec MongoDB et CouchDB, je n&#8217;ai pas été convaincu que les bénéfices dépassaient le coût. Il faudrait un article complet là-dessus (qu&#8217;on m&#8217;a d&#8217;ailleurs demandé).</p>
<p>Question OS. c&#8217;est du CentOS avec Max (il a plus l&#8217;habitude) ou du Ubuntu Server pour mes autres projets. Je reste sur les LTS. Ce n&#8217;est pas un choix très réfléchi, c&#8217;est surtout par habitude.</p>
<p>Pas de machine virtuelle. On a essayé, sans y trouver un grand intérêt :</p>
<ul>
<li>Il faut quand même faire des scripts de migration, donc autant s&#8217;en servir pour le déploiement.</li>
<li>On perd en perfs.</li>
<li>Les erreurs liées au mal-fonctionnement d&#8217;une VM sont absolument indébuggables.</li>
<li>Si on ne fait pas la VM soit-même, il faut mettre ses couilles dans les mains d&#8217;un prestataire de service. J&#8217;ai horreur de ça.</li>
<li>Trouver des gens avec la compétence pour gérer une VM, c&#8217;est difficile. Un script de déploiement, c&#8217;est du code que tout dev saura déjà lire. Par extension ça veut dire que je m&#8217;y replonge facilement des semaines plus tard.</li>
</ul>
<p>Et donc pour le déploiement, j&#8217;utilise <a href="http://sametmax.com/travailler-moins-pour-gagner-plus-en-15-minutes-avec-python-fabric/">fabric</a>, avec <a href="https://github.com/ronnix/fabtools/">fabtools</a>.</p>
<p>Ce n&#8217;est pas la solution la plus efficace, d&#8217;autant que ça limite à Python 2.7, mais c&#8217;est la plus simple. C&#8217;est juste du code Python. N&#8217;importe qui peut comprendre le déploiement en 15 minutes. Ça se modifie vite, s&#8217;adapte facilement. </p>
<p>Il faut comprendre qu&#8217;on a jamais plus d&#8217;une dizaine de serveurs pour un projet, ces choix sont donc faits en fonction de cela. Il va sans dire que si vous gérez un parc de centaines de machines, ça ne sera pas du tout le même choix technique. Peut être que Chef ou des VM seront alors carrément plus intéressants. Peut être que le NoSQL et sa capacité au scaling sera bien plus rentable.</p>
<p>Il ne s&#8217;agit pas de décrier les technos que nous n&#8217;utilisons pas. Il s&#8217;agit juste de dire, voilà les choix que nous avons faits, dans tel contexte, pour telles (bonnes ou mauvaises) raisons.</p>
<p>Durant les dernières années, on a ajouté <a href="http://redis.io/">Redis</a> à notre stack. C&#8217;est un outil fantastique qui sert à tout : de la base de données pour les trucs simples (il y a des fois ou un schéma est overkill) à la solution de caching. C&#8217;est ce qu&#8217;on a de plus proche du NoSQL.</p>
<p>L&#8217;outil est tellement simple à installer (vraiment le degré zero de la maintenance, c&#8217;est beau) et à utiliser que ça ne vaut juste pas le coup de s&#8217;en priver. </p>
<p>Du coup, plus de memcache. Toutes les grosses requêtes sont sauvegardées dans Redis, dès qu&#8217;on fait un script qui a besoin de persistance temporaire, Redis, pour communiquer entre plusieurs process, Redis, pour toutes les opérations qui ont besoin de grosses perfs comme les stats, Redis. Vive Redis.</p>
<p>D&#8217;ailleurs on utilise Redis aussi comme broker pour notre gestionnaire de queues et de taches : <a href="http://sametmax.com/files-de-taches-et-taches-recurrentes-avec-celery/">celery</a>. Si vous pythonez, je vous recommande chaudement celery pour toutes les tâches en background, les crawlers, les chaînes de process, etc.</p>
<p>On a aussi du moteur de recherche. Là on tape dans du <a href="http://lucene.apache.org/solr/">Solr</a> (avec <a href="http://haystacksearch.org/">haystack</a>). C&#8217;est très puissant, en tout cas syntaxiquement car ça ne fait pas de sémantique. Ne vous attendez donc pas à rattraper Google. Mais c&#8217;est aussi méga chiant à configurer et très lourd. Je pense qu&#8217;un jour on va migrer sur <a href="http://www.elasticsearch.org/">ElasticSearch</a>, mais c&#8217;est pas la priorité. Don&#8217;t fix what ain&#8217;t broken.</p>
<p>Devant tout ça on a <a href="http://nginx.org/">Nginx</a>. Comme beaucoup on a fait Apache => Cherokee => lighttp => nginx. Et franchement, je ne reviendrai jamais en arrière : plus léger, plus rapide, plus facile à installer et à configurer, plus versatile. Nginx fait tout, et mieux. </p>
<p>En proxy on a du <a href="http://gunicorn.org/">gunicorn</a>. Parce qu&#8217;on avait la flemme de configurer uwsgi et qu&#8217;on a pris l&#8217;habitude.</p>
<p>Après on utilise plein de libs, de petits outils, etc. Mais ça c&#8217;est le gros de notre archi.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/la-stack-techno-quon-utilise-pour-faire-un-site-web-et-pourquoi/feed/</wfw:commentRss>
		<slash:comments>33</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">7648</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/11/nZ9b9.jpg" length="67160" type="image/jpg" />	</item>
		<item>
		<title>Afficher l&#8217;IP d&#8217;un visiteur &#8211; Django vs Nginx</title>
		<link>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/</link>
		<comments>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/#comments</comments>
		<pubDate>Fri, 25 Oct 2013 03:53:30 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Programmation]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[real ip]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=7525</guid>
		<description><![CDATA[dis moi quelle est ton IP et je te dirais rien.]]></description>
				<content:encoded><![CDATA[<p>Lorsque l&#8217;on veut connaitre son ip on fait souvent appel à des sites du genre: <a href="http://www.whatismyip.com/">whatismyip.com</a>, <a href="http://www.mon-ip.com/">mon-ip.com</a> ou on utilise un ifconfig en ssh.<br />
Des fois on a aussi besoin de connaître l&#8217;ip d&#8217;un visiteur sur son site, 2 petites méthodes pour le faire sous Django et Nginx.</p>
<p><strong>Sous Django:</strong> </p>
<p>Dans l&#8217;<a href="https://docs.djangoproject.com/en/dev/topics/http/urls/">Urlconf</a></p>
<pre lang="python" >
urlpatterns = patterns('',
    # return client IP
    url(r'^my_ip$', get_ip),
)
</pre>
<p>Créez une <a href="https://docs.djangoproject.com/en/dev/topics/http/views/">vue</a> du nom de get_ip qui sera utilisée par l&#8217;urlconf</p>
<pre lang="python" >
from django import http
 
def get_ip(request):
    """
        Vue qui retourne l'IP du client
    """
    try:

    	# récupère l'ip du client
        return http.HttpResponse(request.META["REMOTE_ADDR"] )

    except Exception, e:
        return http.HttpResponse('error %s' % e)
</pre>
<p>Le code ci-dessus peut retourner l&#8217;adresse locale (127.0.0.1) dans ce cas il faut tester l&#8217;existence de la variable <strong>HTTP_X_REAL_IP</strong>, certains serveurs web ont besoin d&#8217;être <a href="http://rtcamp.com/tutorials/nginx/forwarding-visitors-real-ip/">configuré</a>. </p>
<p><strong>Sous Nginx:</strong></p>
<p>Dans le fichier de configuration de nginx on écrit une nouvelle <a href="http://wiki.nginx.org/HttpCoreModule#location">location</a></p>
<pre lang="python" >
# return client ip
location /my_ip {
    default_type 'text/plain';
    content_by_lua 'ngx.print(ngx.var.remote_addr)';
}
</pre>
<p>il suffit de se rendre à l&#8217;url http://monsite.com/my_ip pour voir s&#8217;afficher son ip. Cependant il faut avoir nginx compilé avec le module <a href="http://wiki.nginx.org/HttpLuaModule">Lua</a> ce qui peut être délicat si l&#8217;on a jamais compilé d&#8217;application.</p>
<p><strong><br />
Conclusion:</strong></p>
<p>Si l&#8217;on s&#8217;en réfère aux deux exemples ci dessus on serait tenté d&#8217;utiliser Nginx car en une seule ligne tout le bazar est réglé.<br />
Le hic c&#8217;est qu&#8217;il faut que Nginx soit compilé avec le module Lua pour afficher l&#8217;ip (sauf si quelqu&#8217;un connaît une autre façon d&#8217;afficher un message de sortie).<br />
La version Django n&#8217;est pas fiable à 100% car suivant comment est configuré votre serveur web il se peut que vous vous retrouviez avec une ip du genre 127.0.0.1.<br />
Il y a aussi la possibilité de parser le résultat des sites web cités en tout début d&#8217;article, certains proposent des Api je crois mais vous dépendez d&#8217;un autre service (on faisait ça au début) qui peuvent vous lâcher à tout moment (ce qui nous est arrivé).<br />
Personnellement je compile toujours nginx avec Lua et quelques autres modules, ça permet de s&#8217;affranchir de plus en plus du backend.</p>
<p>PS: j&#8217;ai mis à jour le titre car il laissait sous-entendre autre chose (merci à Sébastien)</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/afficher-la-vrai-ip-dun-visiteur-django-vs-nginx/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">7525</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/10/identity.jpg" length="31647" type="image/jpg" />	</item>
		<item>
		<title>Qu&#8217;est-ce que WSGI et à quoi ça sert ?</title>
		<link>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/</link>
		<comments>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/#comments</comments>
		<pubDate>Wed, 03 Jul 2013 10:36:16 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[bottle]]></category>
		<category><![CDATA[cherrypy]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[server]]></category>
		<category><![CDATA[wsgi]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=6544</guid>
		<description><![CDATA[On va dire que je me répète, mais <a href="https://en.wikipedia.org/wiki/Wsgi">WSGI</a> est typiquement le cas d'une notion simple et super mal expliquée sur le Web.]]></description>
				<content:encoded><![CDATA[<p>On va dire que je me répète, mais <a href="https://en.wikipedia.org/wiki/Wsgi">WSGI</a> est typiquement le cas d&#8217;une notion simple et super mal expliquée sur le Web.</p>
<p>C&#8217;est terrible ça, une vrai maladie. Ça me donne envie de faire des vidéos comme le joueur du Grenier pour râler à voix haute.</p>
<p>Bref.</p>
<p>Donc WSGI a le même but que FastCGI, SCGI, or AJP : c&#8217;est une norme qui sert à définir comment un serveur Python et son application peuvent discuter. Ça été pondu pour que tous les serveurs et toutes les applications Python qui respectent la norme soient garantis de pouvoir s&#8217;interfacer.</p>
<p>Ça, c&#8217;est la définition que vous voyez partout. Super, mais concrètement ça veut dire quoi ?</p>
<h2>WSGI, c&#8217;est juste une convention de discussion</h2>
<p>Un bon dessin vaut mieux&#8230;</p>
<div id="attachment_6545" style="width: 465px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2013/07/wsgi.png" class="grouped_elements" rel="tc-fancybox-group6544"><img class=" wp-image-6545  " title="C'est compliqué de faire un schéma comme ça sérieux ? Ah ça pond une norme de 30 pages mais ça peut pas faire 3 ronds dans paint." src="http://sametmax.com/wp-content/uploads/2013/07/wsgi.png" alt="Schéma du fonctionnement de WSGI" width="455" height="644" /></a><p class="wp-caption-text">C&#39;est compliqué de faire un schéma comme ça sérieux ? Ah ça pond une norme de 30 pages mais ça peut pas faire 3 ronds dans paint.</p></div>
<p>D&#8217;un côté vous avez des serveurs comme ceux de cherrypy, de paste, de werkzeug ou comme la commande runserver de Django, ou tels que les serveurs gunicorn, Apache (avec mod_wsgi). Ces logiciels ont pour boulot d’accueillir une requête HTTP et de renvoyer la réponse. Ils ont des problématiques comme : gérer les sockets, gérer plusieurs processus en parallèle, éviter qu&#8217;un pirate se balade sur votre serveur, etc.</p>
<p>De l&#8217;autre côté vous avez votre application. 9 fois sur 10, votre site Web, donc votre code. Sa problématique c&#8217;est de recevoir une requête, la comprendre, et générer une réponse en tapant dans la base de données, et en faisant sa popotte HTML.</p>
<p>Il faut donc que votre serveur dialogue avec votre app, qu&#8217;il lui passe la requête, que votre app la gère, retourne la réponse, et file la réponse au serveur. Alors le serveur envoie la réponse au navigateur.</p>
<p>C&#8217;est la chose la plus mal expliquée : il y a deux parties à WSGI. Une pour le serveur, et une pour l&#8217;application.</p>
<p>Un serveur est dit &#8220;compatible WSGI&#8221; quand il est capable de transmettre une requête HTTP normale à votre application via le protocole WSGI, et qu&#8217;il est capable de récupérer une réponse HTTP depuis votre application via le protocole WSGI pour en faire une requête HTTP normale.</p>
<p>Une application est dite &#8220;compatible WSGI&#8221; quand elle est capable de recevoir une requête HTTP <strong>transformée en un objet Python</strong> selon la norme WSGI, et qu&#8217;elle retourne une réponse HTTP <strong>sous la forme d&#8217;un objet Python</strong> selon la norme WSGI.</p>
<h2>J&#8217;avais demandé concrètement, show me the fucking code !</h2>
<p>Côté serveur WSGI, on doit lui passer le point d&#8217;entrée de votre app.</p>
<p>Le point d&#8217;entrée est un module Python qui contient une variable nommé <code>application</code>.</p>
<p>C&#8217;est tout.</p>
<p>La variable application doit contenir votre application compatible WSGI.</p>
<p>Une application compatible WSGI a un certain nombre de méthodes pour accepter en paramètres un objet requête HTTP, et retourner un objet réponse HTTP, mais la bonne nouvelle, c&#8217;est que <strong>vous n&#8217;avez absolument pas besoin de savoir comment ça marche</strong>.</p>
<p>En effet, tous les frameworks compatibles WSGI (bottle, django, cherrypy, etc) ont une fonction qui retourne cette application toute faite.</p>
<p>Par exemple, avec bottle, mon fichier wsgi va contenir :</p>
<pre lang="python">from site import app

application = app</pre>
<p>C&#8217;est tout. <code>app</code>, le décorateur qui permet de faire <code>@app.route('/')</code> dans le code du site bottle, est déjà une application WSGI.</p>
<p>Pour Django, ça va donner un truc comme :</p>
<pre lang="python">import os
# ont dit quel est le module de settings Django
os.environ["DJANGO_SETTINGS_MODULE"] = "project.settings"

# et on fabrique l'application WSGI avec une fonction
# que Django nous donne
from django.core.wsgi import get_wsgi_application

application = get_wsgi_application()
</pre>
<p>Le simple fait qu&#8217;il y ait une variable nommée <code>application</code> fait que le serveur va se débrouiller. Tout ce qu&#8217;il y a à faire, c&#8217;est passer en paramètre ce module au serveur, et comment le faire dépend du serveur.</p>
<p>Par exemple pour gunicorn, c&#8217;est le premier paramètre de la commande qu&#8217;on utilise pour lancer le serveur :</p>
<pre lang="bash">
gunicorn nom_du_module</pre>
<p>Il faut que le module soit importable (on peut passer l&#8217;option <code>--pythonpath</code> pour s&#8217;en assurer.)</p>
<p>Pour Apache et mod_wsgi, ça se fait dans le fichier de config <em>apache.conf</em>:</p>
<pre lang="xml">WSGIScriptAlias / /chemin/version/module.wsgi</pre>
<p>Bref, faire dialoguer un serveur et une application WSGI, c&#8217;est con comme la lune :</p>
<ol>
<li>Faire un module qui contient une variable nommée <code>application</code> contenant l&#8217;app WSGI.</li>
<li>Dire au serveur où se trouve le fichier</li>
</ol>
<h2>Avantages et inconvénients de WSGI</h2>
<p>Parmi les avantages, on retrouve :</p>
<ul>
<li>Pas de parsing de la requête au niveau de l&#8217;application.</li>
<li>Entrée de toutes les apps WSGI normalisées.</li>
<li>Tous les logiciels WSGI sont compatibles entre eux.</li>
<li>Le module WSGI reste chargé en mémoire une bonne fois pour toute, pas besoin de le recréer à chaque requête.</li>
<li>WSGI se suffit à lui même pour écrire une application. Dans la théorie, on n&#8217;a même pas besoin de framework.</li>
</ul>
<p>Quant aux inconvénients :</p>
<ul>
<li>En pratique il y a très peu de code partagé entre les applications WSGI. La communication sur WSGI s&#8217;est très mal passée et cela reste quelque chose de mystérieux pour la plupart des développeurs.</li>
<li>WSGI ne gère pas les websockets, et la norme est en train d&#8217;être mise à jour pour cela. Mais cela prend du temps et les websockets sont déjà là, du coup les gens se tournent vers des solutions non WSGI (tornado, twisted, etc).</li>
<li>Certains serveurs ne gèrent pas WSGI (comme nginx ou lighttpd), du coup on ne peut pas communiquer directement entre l&#8217;app et eux. Il faut un intermédiaire. C&#8217;est pour cela qu&#8217;on voit très souvent des setups comme nginx <=> gunicorn <=> django, avec un serveur WSGI qui sert d&#8217;intermédiaire. Il y a tout de même le bénéfice de pouvoir gérer parfaitement indépendamment le processus WSGI du serveur HTTP, ce qui est très pratique pour le debug, l&#8217;administration système, le déploiement, etc.</li>
<li>WSGI, c&#8217;est du Python. Qui dit Python, dit import, qui dit import, dit PYTHON PATH. 90% des erreurs de mise en prod sont des erreurs d&#8217;import, et pour cette raison <code>sys.path</code> est presque toujours manipulé dans un fichier qui contient une application WSGI.</li>
</ul>
<h2>Pour la culture</h2>
<p>Voici à quoi ressemble un hello world en WSGI :</p>
<pre lang="python">def application(environ, start_response):
    start_response('200 OK', [('Content-Type', 'text/plain')])
    yield 'Hello World\n'</pre>
<p>Et oui, c&#8217;est très simple, et il n&#8217;y a rien à importer. La norme WSGI est une convention : il doit y avoir une variable nommée <code>application</code> (ici la variable c&#8217;est le nom de la fonction), et cette variable doit contenir une application WSGI.</p>
<p>Mais une application WSGI, c&#8217;est juste un callable (ici une fonction) qui accepte en paramètres <code>environ</code> (la requête), <code>start_response</code> (une fonction qui écrit l&#8217;en-tête de la réponse) et qui retourne un générateur de string. C&#8217;est tout.</p>
<p>Il n&#8217;y a rien de magique. C&#8217;est une simple interface sur laquelle tout le monde s&#8217;est mis d&#8217;accord.</p>
<p>Quand on fait en Django:</p>
<pre lang="python">application = get_wsgi_application()</pre>
<p>En fait Django ne fait que fabriquer une fonction comme on vient de voir, qui derrière appelle votre application Django.</p>
<p>En revanche, comme on utilise souvent Django derrière nginx, le setup ressemble très souvent à ça :</p>
<div id="attachment_6546" style="width: 465px" class="wp-caption aligncenter"><a href="http://sametmax.com/wp-content/uploads/2013/07/wsgi_with_nginx.png" class="grouped_elements" rel="tc-fancybox-group6544"><img class="size-full wp-image-6546" title="Quand on voit &quot;socket&quot;, ça fait peur, mais c'est juste une ligne de config qui point généralement vers localhost:8000." src="http://sametmax.com/wp-content/uploads/2013/07/wsgi_with_nginx.png" alt="Schém d'utilistation de WSGI avec Nginx" width="455" height="644" /></a><p class="wp-caption-text">Quand on voit &quot;socket&quot;, ça fait peur, mais c&#39;est juste une ligne de config qui point généralement vers localhost:8000.</p></div>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/quest-ce-que-wsgi-et-a-quoi-ca-sert/feed/</wfw:commentRss>
		<slash:comments>30</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">6544</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/07/v2TyF.jpg" length="31544" type="image/jpg" />	</item>
		<item>
		<title>Initiation à Varnish &#8211; Accélerer un blog WordPress</title>
		<link>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/</link>
		<comments>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/#comments</comments>
		<pubDate>Sun, 31 Mar 2013 08:54:54 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[Web]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[varnish]]></category>
		<category><![CDATA[wordpress]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4416</guid>
		<description><![CDATA[Wordpress est devenu une usine à gaz avec le temps. Naviguer sur un blog sous Wordpress peut devenir pénible lorsque ce dernier a beaucoup de contenu ou de visiteurs. Des plugins censés mettre en cache les pages existent comme WP Cache, il y a aussi une façon d'attaquer le problème autrement avec Varnish.]]></description>
				<content:encoded><![CDATA[<p><a href="https://www.varnish-cache.org/">Varnish</a> est un service qui permet de mettre en cache (sur disque ou en mémoire) certains contenus de votre site. Beaucoup de gros sites l&#8217;utilisent pour sa puissance et ses options de configuration.<br />
Il est plutôt facile à installer mais ça se corse lorsqu&#8217;il faut le configurer car il peut ne rien cacher du tout, surtout avec la config par défaut.</p>
<p>Nous allons voir ici une configuration pour un site sous WordPress avec un serveur Nginx, Varnish étant placé en Front c&#8217;est à dire devant Nginx (il y a aussi le mode sandwich Nginx / Varnish / Backend).</p>
<p><img class="aligncenter size-full wp-image-4417" title="Varnish en Front" src="http://sametmax.com/wp-content/uploads/2013/02/varnish.png" alt="" width="580" height="272" /></p>
<p><strong>Installation de Varnish sous ubuntu:<br />
</strong></p>
<pre lang="bash">
sudo apt-get install varnish
</pre>
<p>Il y a 2 fichiers qu&#8217;il faut retenir pour Varnish, le fichier avec les règles et le fichier de config du service.<br />
<strong><br />
Configurer le service, On va faire en sorte que Varnish écoute sur le port 80:</strong></p>
<pre lang="bash">
vi /etc/default/varnish
</pre>
<pre lang="bash">
DAEMON_OPTS="-a :80 \
             -T localhost:6082 \
             -f /etc/varnish/default.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m"
</pre>
<p>Trouvez cette ligne dans le fichier de conf et mettez 80 pour l&#8217;option -a.<br />
<em>malloc</em> va sauver le cache en mémoire à hauteur de 256 MB, on peut sauvegarder sur disque si on a un SSD (ex: -s file,/var/lib/varnish/varnish_storage.bin,1G&#8221;).</p>
<p><strong>Configurer les règles de cache:</strong></p>
<pre lang="bash">
vi /etc/varnish/default.vcl
</pre>
<pre lang="bash">
#
# Varnish 3 configuration for WordPress
#
# On Debian OS:  /etc/varnish/default.vcl
#
# Nicolas Hennion (aka) Nicolargo
#

# Set the default backend (Nginx server for me)
backend default {
	# My Nginx server listen on IP address 127.0.0.1 and TCP port 8080
	.host = "127.0.0.1";
	.port = "8080";
	# Increase guru timeout
	# http://vincentfretin.ecreall.com/articles/varnish-guru-meditation-on-timeout
	.first_byte_timeout = 300s;
}

# This function is used when a request is send by a HTTP client (Browser) 
sub vcl_recv {
	# Block the forbidden IP addresse
	if (client.ip ~ forbidden) {
        	error 403 "Forbidden";
	}

	# Only cache the following sites
	if ((req.http.host ~ "(sametmax.com)")) { 
		set req.backend = default; 
	} else { 
		return (pass); 
	}

	# Normalize the header, remove the port (in case you're testing this on various TCP ports)
	set req.http.Host = regsub(req.http.Host, ":[0-9]+", "");

	# Post requests will not be cached
	if (req.http.Authorization || req.request == "POST") {
		return (pass);
	}

	# --- WordPress specific configuration
	
	# Did not cache the RSS feed
	if (req.url ~ "/feed") {
		return (pass);
	}

	# Blitz hack
        if (req.url ~ "/mu-.*") {
                return (pass);
        }

	
	# Did not cache the admin and login pages
	if (req.url ~ "/wp-(login|admin)") {
		return (pass);
	}

	# Remove the "has_js" cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "has_js=[^;]+(; )?", "");

	# Remove any Google Analytics based cookies
	set req.http.Cookie = regsuball(req.http.Cookie, "__utm.=[^;]+(; )?", "");

	# Remove the Quant Capital cookies (added by some plugin, all __qca)
	set req.http.Cookie = regsuball(req.http.Cookie, "__qc.=[^;]+(; )?", "");

	# Remove the wp-settings-1 cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wp-settings-1=[^;]+(; )?", "");

	# Remove the wp-settings-time-1 cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wp-settings-time-1=[^;]+(; )?", "");

	# Remove the wp test cookie
	set req.http.Cookie = regsuball(req.http.Cookie, "wordpress_test_cookie=[^;]+(; )?", "");

	# Are there cookies left with only spaces or that are empty?
	if (req.http.cookie ~ "^ *$") {
		    unset req.http.cookie;
	}
	
	# Cache the following files extensions 
	if (req.url ~ "\.(css|js|png|gif|jp(e)?g|swf|ico)") {
		unset req.http.cookie;
	}

	# Normalize Accept-Encoding header and compression
	# https://www.varnish-cache.org/docs/3.0/tutorial/vary.html
	if (req.http.Accept-Encoding) {
		# Do no compress compressed files...
		if (req.url ~ "\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)$") {
			   	remove req.http.Accept-Encoding;
		} elsif (req.http.Accept-Encoding ~ "gzip") {
		    	set req.http.Accept-Encoding = "gzip";
		} elsif (req.http.Accept-Encoding ~ "deflate") {
		    	set req.http.Accept-Encoding = "deflate";
		} else {
			remove req.http.Accept-Encoding;
		}
	}

	# Check the cookies for wordpress-specific items
	if (req.http.Cookie ~ "wordpress_" || req.http.Cookie ~ "comment_") {
		return (pass);
	}
	if (!req.http.cookie) {
		unset req.http.cookie;
	}
	
	# --- End of WordPress specific configuration

	# Did not cache HTTP authentication and HTTP Cookie
	if (req.http.Authorization || req.http.Cookie) {
		# Not cacheable by default
		return (pass);
	}

	# Define the default grace period to serve cached content
	set req.grace = 30s;
	
	# Cache all others requests
	return (lookup);
}
 
sub vcl_pipe {
	return (pipe);
}
 
sub vcl_pass {
	return (pass);
}
 
# The data on which the hashing will take place
sub vcl_hash {
 	hash_data(req.url);
 	if (req.http.host) {
     	hash_data(req.http.host);
 	} else {
     	hash_data(server.ip);
 	}

	# If the client supports compression, keep that in a different cache
    	if (req.http.Accept-Encoding) {
        	hash_data(req.http.Accept-Encoding);
	}
     
	return (hash);
}
 
# This function is used when a request is sent by our backend (Nginx server)
sub vcl_fetch {
	# Remove some headers we never want to see
	unset beresp.http.Server;
	unset beresp.http.X-Powered-By;

	# For static content strip all backend cookies
	if (req.url ~ "\.(css|js|png|gif|jp(e?)g)|swf|ico") {
		unset beresp.http.cookie;
	}

	# Only allow cookies to be set if we're in admin area
	if (beresp.http.Set-Cookie && req.url !~ "^/wp-(login|admin)") {
        	unset beresp.http.Set-Cookie;
    	}

	# don't cache response to posted requests or those with basic auth
	if ( req.request == "POST" || req.http.Authorization ) {
        	return (hit_for_pass);
    	}
 
    	# don't cache search results
	if ( req.url ~ "\?s=" ){
		return (hit_for_pass);
	}
    
	# only cache status ok
	if ( beresp.status != 200 ) {
		return (hit_for_pass);
	}

	# A TTL of 24h
	set beresp.ttl = 24h;
	
	return (deliver);
}
 
# The routine when we deliver the HTTP request to the user
# Last chance to modify headers that are sent to the client
sub vcl_deliver {
	if (obj.hits > 0) { 
		set resp.http.X-Cache = "cached";
	} else {
		set resp.http.x-Cache = "uncached";
	}

	# Remove some headers: PHP version
	unset resp.http.X-Powered-By;

	# Remove some headers: Apache version & OS
	unset resp.http.Server;

	# Remove some heanders: Varnish
	unset resp.http.Via;
	unset resp.http.X-Varnish;

	return (deliver);
}
 
sub vcl_init {
 	return (ok);
}
 
sub vcl_fini {
 	return (ok);
}
</pre>
<p>Avant toute chose voici la doc :) : <a href="https://www.varnish-cache.org/docs/3.0/">https://www.varnish-cache.org/docs/3.0/</a><br />
Ce qu&#8217;il faut retenir de ce fichier de règles c&#8217;est les parties normalisation, enlever les cookies inutiles (car si cookie alors pas de cache) et ne pas mettre en cache l&#8217;admin. Cette config tourne actuellement sur S&#038;M.</p>
<p>Un point intéressant c&#8217;est le debug, vous pouvez mettre un <em>set resp.http.X-Cache = &#8220;cached&#8221;;</em> et vérifier les headers de votre serveur dans le debug de votre navigateur pour savoir si oui ou non la page servie est en cache.</p>
<p><strong>L&#8217;admin varnish en ligne de commande:</strong><br />
Varnish possède une admin en ligne de commande où l&#8217;on peut par exemple purger le cache d&#8217;une ou plusieurs pages.<br />
Tapez <em>varnishadm</em> dans le shell:</p>
<pre lang="bash">
varnishadm
200        
-----------------------------
Varnish Cache CLI 1.0
-----------------------------
Linux,3.2.0-25-virtual,x86_64,-smalloc,-smalloc,-hcritbit

Type 'help' for command list.
Type 'quit' to close CLI session.

varnish> ban.url /toto/ma-page.php
</pre>
<p>Pour purger une page on va utiliser la commande ban.url et y ajouter une partie de l&#8217;url à purger. On peut utiliser un ban en appelant également une url de purge avec Curl ou Wget pour les automations, il y a un excellent article <a href="http://binbash.fr/2011/11/15/purger-le-cache-de-varnish-3/">sur la purge ici.</a></p>
<p><strong>Configurer Nginx:</strong><br />
Une fois varnish installé, on va modifier un peu nginx pour que la liaison puisse se faire. Ci-dessous l&#8217;exemple de notre conf nginx.</p>
<pre lang="bash">

server {
    listen      8080;
    server_name  sametmax.com  ;
    root         /unrep/sametmax/;  # absolute path to your WordPress installation
    index index.php index.html;
    set_real_ip_from        127.0.0.1;
    real_ip_header          X-Forwarded-For;

    location ~ \.php$ {
        include        /etc/nginx/fastcgi_params;
        fastcgi_pass   127.0.0.1:53217;
        fastcgi_index index.php;
        fastcgi_buffers 8 16k;
        fastcgi_buffer_size 32k;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    }

</pre>
<p>Pour PHP on utilise spawn-fcgi que l&#8217;on gère avec <a href="http://supervisord.org/">supervisor</a> dont voici la conf dans /etc/supervisord.conf</p>
<pre lang="bash">
[program:php5-cgi]
command=/usr/local/bin/spawn-fcgi -u adolf -n -a 127.0.0.1 -p 53217 -P /tmp/fastcgi-php.pid -F 4 -- /usr/bin/php-cgi
redirect_stderr=true          ; redirect proc stderr to stdout (default false)
user=sametmax
autostart=true
autorestart=true
startsecs=10
startretries=9999999999999
stdout_logfile=/var/log/php5-cgi/php5-cgi.log
stdout_logfile_maxbytes=10MB   ; max # logfile bytes b4 rotation (default 50MB)
</pre>
<p><strong>Pour résumer:</strong></p>
<p>Dans cette configuration Varnish est en front end et va décider quand servir une page prise dans le cache (disque dur ou RAM) et quand interroger le backend pour servir une nouvelle page.<br />
Sur d&#8217;autres sites à fort trafic on a mis Nginx en front end car il encaisse beaucoup plus les hits et qu&#8217;il fait très bien le boulot pour servir des pages statiques.</p>
<p><strong>Attention!</strong><br />
Même si Varnish n&#8217;est pas compliqué à installer il peut être un vrai casse-tête quand il s&#8217;agit de cacher des pages. Pensez donc bien à normaliser vos headers (user-agent, gzip, etc), utilisez le debug.<br />
Bien configuré Varnish vous booste un serveur avec une réélle efficacité, il nous a sauvé 2 sites jusqu&#8217;à présent, ça sera d&#8217;ailleurs un standard sur nos prochains sites.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/initiation-a-varnish-accelerer-un-blog-wordpress/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">4416</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/03/back_to_the_future.jpg" length="23411" type="image/jpg" />	</item>
		<item>
		<title>nginx: [emerg] &#8220;worker_processes&#8221; directive is not allowed here in /usr/local/nginx/conf/nginx.conf:3</title>
		<link>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/</link>
		<comments>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/#comments</comments>
		<pubDate>Wed, 13 Feb 2013 10:05:56 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[nginx]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=4452</guid>
		<description><![CDATA[Cette erreur arrive quand la directive "worker_processes" est incluse une deuxième fois. Typiquement cela arrive quand on a <code>include *.conf</code> dans son nginx.conf et que cela inclu nginx.conf lui même. ]]></description>
				<content:encoded><![CDATA[<p>Cette erreur arrive quand la directive &#8220;worker_processes&#8221; est incluse une deuxième fois. Typiquement cela arrive quand on a <code>include *.conf</code> dans son <em>nginx.conf</em> et que cela inclut <em>nginx.conf</em> lui même. </p>
<p>Il faut donc être spécifique sur les fichiers à inclure <code>include site.conf</code> ou déplacer <em>nginx.conf</em> dans un autre dossier que celui des sous fichiers de configuration.</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nginx-emerg-worker_processes-directive-is-not-allowed-here-in-usrlocalnginxconfnginx-conf3/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">4452</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2013/02/Tomei-Evo-X-engine.jpg" length="268187" type="image/jpg" />	</item>
		<item>
		<title>Nginx en reverse proxy + Gunicorn pour vos apps Django</title>
		<link>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/</link>
		<comments>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/#comments</comments>
		<pubDate>Mon, 03 Dec 2012 19:48:22 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[gunicorn]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[reverse proxy]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=3431</guid>
		<description><![CDATA[Petit exemple de configuration de Nginx en reverse proxy avec Gunicorn.]]></description>
				<content:encoded><![CDATA[<p>Nginx est bien connu depuis quelques années. Puissant serveur HTTP, il peut être utilisé en tant que reverse proxy (mandataire inverse en Français) afin d&#8217;améliorer les performances.<br />
Je vous copie/colle les avantages depuis <a href="http://fr.wikipedia.org/wiki/Mandataire_inverse">Wikipédia</a> parce que je suis une feignasse:</p>
<p><strong>cache :</strong> le mandataire inverse ou (reverse proxy) peut décharger les serveurs Web de la charge de pages/objets statiques (pages HTML, images) par la gestion d&#8217;un cache local. La charge des serveurs Web est ainsi généralement diminuée, on parle alors d&#8217;« accélérateur web » ou d&#8217;« accélérateur HTTP ».<br />
<strong>Intermédiaire de sécurité :</strong> le mandataire inverse protège un serveur Web des attaques provenant de l&#8217;extérieur. En effet, la couche supplémentaire apportée par les mandataires inverses peut apporter une sécurité supplémentaire. La ré-écriture programmable des URL permet de masquer et de contrôler, par exemple, l&#8217;architecture d&#8217;un site web interne. Mais cette architecture permet surtout le filtrage en un point unique des accès aux ressources Web.<br />
<strong>Chiffrement SSL :</strong> le mandataire inverse peut être utilisé en tant que « terminateur SSL », par exemple par le biais de matériel dédié,<br />
<strong>Répartition de charge :</strong> le mandataire inverse peut distribuer la charge d&#8217;un site unique sur plusieurs serveurs Web applicatifs. Selon sa configuration, un travail de ré-écriture d&#8217;URL sera donc nécessaire,<br />
<strong>Compression :</strong> le mandataire inverse peut optimiser la compression du contenu des sites.</p>
<p><strong>Pour résumé:</strong></p>
<p><strong>Visiteur &gt; Web &gt; Votre Serveur &gt; Nginx &gt; Gunicorn &gt; Django<br />
</strong></p>
<p>Dans la configuration suivante Nginx va servir les fichiers statiques (images, js, etc) et envoyer le reste des requêtes sur <a href="http://gunicorn.org/#quickstart">Gunicorn</a>. Gunicorn est une interface WSGI entre le serveur HTTP (nginx) et Python, je n&#8217;ai pas trouvé de bonne explication sur WSGI à part le <a href="http://wsgi.readthedocs.org/en/latest/index.html">site officiel </a>fait par des autistes.</p>
<p><strong>Soit la configuration de Gunicorn suivante (on peut le lancer avec <a href="https://0bin.readthedocs.org/en/latest/fr/using_supervisor.html">supervisor</a>):</strong></p>
<pre lang="python">gunicorn_django  myapp.py --bind 127.0.0.1:8080 --log-file /var/log/myapp.gunicorn.log --log-level info --workers 2 --pid /tmp/myapp.pid  --worker-class gevent</pre>
<p>Gunicorn va &#8220;écouter&#8221; en local sur le port 8080, il va logger des infos dans le fichier /var/log/myapp.gunicorn.log (pratique pour le debug si besoin).<br />
Pour les workers et worker-class regardez <a href="http://docs.gunicorn.org/en/latest/configure.html">la doc</a>.</p>
<p><strong>Configurer Nginx: </strong><br />
Dans la conf Nginx on va avoir.</p>
<pre lang="python">server {
        listen       80;
        server_name mysite.com www.mysite.com;

        location /static/ {
            root  /home/myapp/prod;
            gzip  on;
        }

        location / {
            proxy_pass http://127.0.0.1:8080; # Pass to Gunicorn
            proxy_set_header X-Real-IP $remote_addr; # get real Client IP
        }
}</pre>
<p><a href="http://wiki.nginx.org/HttpCoreModule#location">location</a> va indiquer à Nginx ce qu&#8217;il faut faire lorsqu&#8217;il rencontre certaines URL.</p>
<p>Dans notre cas le <strong>location /static/</strong> va dire à Nginx de servir directement tous les fichiers du répertoire /home/myapp/prod/static pour les URL http://mysite.com/static/&#8230; En général les images, javascript, etc.</p>
<p>Pour le reste <strong>location /</strong> va renvoyer les requêtes sur votre serveur Gunicorn qui va les traiter.</p>
<p>proxy_set_header sert à passer à Gunicorn certaines infos comme l&#8217;<a title="Récupérer l’IP client avec Nginx en proxy sous CherryPy/Django/Bottle – proxy_set_header" href="http://sametmax.com/recuperer-lip-client-avec-nginx-en-proxy-sous-cherrypy-proxy_set_header/">IP réelle du client </a>(sinon Gunicorn verrait celle de NGinx 127.0.0.1).</p>
<p>De cette manière on ne surcharge pas Gunicorn pour servir nos fichiers statiques, on ajoute une protection (Nginx).<br />
On peut éventuellement <a href="http://wiki.nginx.org/HttpProxyModule#proxy_cache">mettre en cache</a> certaines pages mais je n&#8217;ai jamais utilisé cette option.<br />
Nginx peut également distribuer la charge sur plusieurs serveurs et se charger de la <a href="https://developers.google.com/speed/articles/gzip">compression des pages</a> (gzip).</p>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/nginx-en-reverse-proxy-gunicorn-pour-vos-apps-django/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">3431</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2012/12/330px-Reverse_proxy_h2g2bob.png" length="16681" type="image/jpg" />	</item>
		<item>
		<title>Servir un fichier protégé avec Django et Nginx</title>
		<link>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/</link>
		<comments>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/#comments</comments>
		<pubDate>Fri, 21 Sep 2012 13:53:38 +0000</pubDate>
		<dc:creator><![CDATA[Sam]]></dc:creator>
				<category><![CDATA[Programmation]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2204</guid>
		<description><![CDATA[Certains fichiers sont réservés à des personnes ayant payé, avec un compte, ou encore protégés par un mot de passe. Problème: django gère l'authentification mais ne doit pas gérer l'upload car c'est le taff du serveur en front end.]]></description>
				<content:encoded><![CDATA[<p>Certains fichiers sont réservés à des personnes ayant payé, avec un compte, ou encore protégés par un mot de passe. Problème: django gère l&#8217;authentification mais ne doit pas gérer l&#8217;upload car c&#8217;est le taff du serveur en front end.</p>
<h2>Etape 1: configurer Nginx</h2>
<p>Je suppose ici que vous avez une config Django classique avec Nginx qui fait un proxy passe vers un serveur WSGI type cherrypy, gunircorn, uwsgi, etc.</p>
<p>Dans votre fichier de config Nginx, rajoutez ceci:</p>
<pre>server {
   ...
   location /secure_upload/{
       internal;
       alias /chemin/absolu/vers/dossier/du/projet/media;
   }
}</pre>
<p>La directive <code>internal</code> s&#8217;assure qu&#8217;une requête extérieur ne peut pas demander d&#8217;accéder à cette adresse.</p>
<h2>Etape 2: authentifier et rediriger avec une vue Django</h2>
<p>Dans cet exemple, on sert uniquement le fichier aux utilisateurs authentifiés. Mais on pourrait très bien le faire sur la saisie d&#8217;un code unique, vérifier les droits d&#8217;accès, etc. J&#8217;ai juste choisi le cas le plus simple.</p>
<pre lang="python">from django.contrib.auth.decorators import login_required
from django.http import HttpResponse
from django.views import static
from django.conf import settings

@login_required() # on accepte uniquement les requête authentifiées
def serve_secure_static(request, path):

    # en mode debug, on demande à Django de servir le fichier histoire de pas
    # être forcé de setuper nginx sur sa machine de dev
    if settings.DEBUG:
        return static.serve(request, path, settings.SECURE_MEDIA_ROOT)

    # Sinon on retourne une réponse VIDE avec en header le chemin de l'url
    # de l'upload interne
    # Nginx va l'intercepter, réaliser qu'il faut qu'il upload ce qu'il y
    # a à cette URL et faire le reste du boulot
    response = HttpResponse()
    response['X-Accel-Redirect'] = '/secure_upload/%s' % path
    return response</pre>
<h2>Etape 3 : configurer Django</h2>
<p>Evidément il vous faut dans le <em>settings.py</em>:</p>
<pre lang="python">MEDIA_ROOT = "/chemin/absolu/vers/dossier/du/projet/media"
SECURE_MEDIA_ROOT = os.path.join(MEDIA_ROOT, 'secure')</pre>
<p>Les dossiers doivent être créés à la mano.</p>
<p>Et dans <em>urls.py</em>:</p>
<pre lang="python">url(r'^download/(?P
.*)$', server_secure_static)</pre>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/servir-un-fichier-protege-avec-django-et-nginx/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">2204</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2012/09/Door-Multi-locks1-300x285.jpg" length="23596" type="image/jpg" />	</item>
		<item>
		<title>Connaître sa version de Nginx</title>
		<link>http://sametmax.com/connaitre-sa-version-de-nginx/</link>
		<comments>http://sametmax.com/connaitre-sa-version-de-nginx/#comments</comments>
		<pubDate>Mon, 17 Sep 2012 13:52:12 +0000</pubDate>
		<dc:creator><![CDATA[Max]]></dc:creator>
				<category><![CDATA[Administration System]]></category>
		<category><![CDATA[nginx]]></category>
		<category><![CDATA[version]]></category>

		<guid isPermaLink="false">http://sametmax.com/?p=2176</guid>
		<description><![CDATA[Connaître facilement sa version du serveur web Nginx]]></description>
				<content:encoded><![CDATA[<p><a href="http://nginx.org/">Nginx</a>, le super serveur web qui n&#8217;est plus à présenter profite de mises à jours régulières. Sa communauté est très active pour le bien de tous. A l&#8217;heure actuelle <a href="http://w3techs.com/technologies/cross/web_server/ranking">Nginx est présent sur plus de 27% des serveurs dont les sites sont dans le top 1000 Alexa </a></p>
<p>Pour savoir si votre version n&#8217;est pas désuète vous pouvez en ligne de commande obtenir la version de Nginx que vous possedez ainsi que les paramètres de compilation.</p>
<p><strong>Connaître sa version de Nginx grace à l&#8217;option -V:</strong></p>
<pre lang="bash">
user@mon_serveur:~# /usr/local/nginx/sbin/nginx -V
nginx version: nginx/1.3.5
built by gcc 4.6.3 (Ubuntu/Linaro 4.6.3-1ubuntu5) 
configure arguments: --prefix=/usr/local/nginx --with-http_flv_module --with-http_mp4_module --with-http_secure_link_module
</pre>
]]></content:encoded>
			<wfw:commentRss>http://sametmax.com/connaitre-sa-version-de-nginx/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
	<post-id xmlns="com-wordpress:feed-additions:1">2176</post-id><enclosure url="http://sametmax.com/wp-content/uploads/2012/09/nginx_logo.gif" length="11716" type="image/jpg" />	</item>
	</channel>
</rss>
